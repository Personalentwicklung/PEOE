<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Baukasten für Copilot-Chat-Agenten</title>
  <style>
    :root{
      --primary:#005A9C;
      --primary-600:#0a66a8;
      --accent:#2FB1C5;
      --bg:#f5f7fa;
      --card-bg:#ffffff;
      --subtle:#eef2f5;
      --muted:#4a5568;
      --text:#1a202c;
      --border:#e2e8f0;
      --shadow:0 4px 14px rgba(0,0,0,0.08);
      --radius:10px;
      --warning:#C05621;
      --success:#2F855A;
      --focus:#2FB1C5;
      --edit-bg:#E8F5E9;
      --edit-border:#81C784;
      --edit-focus:#43A047;
      --badge-bg:#E5E7EB;
      --badge-border:#D1D5DB;
      --container:1024px;
      --space-1:8px;
      --space-2:12px;
      --space-3:16px;
      --space-4:20px;
      --space-5:28px;
      --space-6:36px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:var(--container);margin:0 auto;padding:24px;}
    h1{font-size:28px;margin:0 0 var(--space-4);color:var(--primary);text-align:center}
    h2{font-size:22px;margin:0 0 var(--space-3);color:var(--primary)}
    h3{font-size:18px;margin:0 0 var(--space-2);color:var(--primary)}
    p{margin:0 0 var(--space-3);color:var(--text)}
    .card{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:var(--space-5);margin:0 0 var(--space-5);}
    .subcard{background:var(--subtle);border:1px solid var(--border);border-radius:8px;padding:16px;margin:var(--space-3) 0;}
    .btn{background:var(--primary);color:#fff;border:none;border-radius:999px;padding:12px 20px;font-weight:600;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    .btn:hover{background:var(--primary-600)}
    .btn:focus{outline:3px solid var(--focus);outline-offset:2px}
    .btn--sm{padding:8px 14px;font-size:14px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:20px;flex-wrap:wrap;align-items:flex-start}
    .grow{flex:1 1 320px}
    .subhint{font-size:14px;color:var(--muted);margin:0 0 6px;}
    .subhint--question{font-weight:600;color:var(--text);} 
    .subhint--choose{font-weight:400;} 
    select{width:100%;min-width:280px;max-width:100%;padding:6px;border:1px solid var(--border);border-radius:8px;background:#fff;color:var(--text);font-size:14px;line-height:1.4;}
    select option{font-size:14px;}
    .meta{display:flex;align-items:center;gap:12px;margin-top:8px;color:var(--muted);font-size:14px;}
    .hint{color:var(--warning);font-size:14px;margin-top:6px}
    .preview{margin-top:12px;padding:10px 12px;border:1px dashed var(--border);border-radius:8px;background:#fcfcfd;}
    .editable{display:inline-block;min-width:160px;min-height:1.4em;background:var(--edit-bg);border:1px dashed var(--edit-border);border-radius:6px;padding:2px 6px;line-height:1.6;}
    .editable:focus{outline:2px solid var(--edit-focus);background:#E3F2E5}
    .badge-gray{display:inline-block;min-width:160px;min-height:1.4em;background:var(--badge-bg);border:1px solid var(--badge-border);border-radius:6px;padding:2px 6px;line-height:1.6;}
    .copy-area .title-line{font-weight:700;margin-bottom:8px}
    .copy-msg{margin-top:10px;color:var(--success);display:none}
    #builder{display:none}
    .centered{display:flex;min-height:100vh;align-items:center;justify-content:center}
    .start-card{max-width:760px}
    .top-note{margin-bottom:var(--space-4);padding:12px 14px;border-left:4px solid var(--accent);background:#f3fafc;border-radius:6px;}
    .actions-line{display:flex;justify-content:flex-end;gap:10px;margin-top:14px;flex-wrap:wrap;}
    .info-btn{background:#ffffff;color:var(--primary);border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-weight:600;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.06);}
    .info-btn:hover{background:#f7fafc}
    .info-btn:focus{outline:3px solid var(--focus);outline-offset:2px}
    .info-panel{margin-top:12px;padding:12px 14px;border:1px solid var(--border);border-radius:8px;background:#fff;box-shadow:var(--shadow);display:none;}
    .info-panel h4{margin:0 0 8px;font-size:16px;color:var(--primary);}
    .info-panel p{margin:0 0 10px;color:var(--text)}
    .info-panel .close-info{background:transparent;color:var(--muted);border:1px solid var(--border);border-radius:999px;padding:6px 10px;cursor:pointer;}
    .info-panel .close-info:hover{background:#f8fafc}
    @media (max-width: 720px){.container{padding:16px;}h1{font-size:24px}}
  </style>
</head>
<body>
  <!-- START: Startscreen -->
  <section id="start" class="centered">
    <div class="card start-card">
      <div class="container">
        <h1>Baukasten für Copilot-Chat-Agenten</h1>
        <p>Dieser Baukasten unterstützt dich dabei, einen vollständig einsatzbereiten Copilot Chat Agenten zu erstellen. Du wählst die gewünschten Eigenschaften aus, passt die erzeugten Textbausteine bei Bedarf an und kopierst anschließend das fertige Agenten Script in einen neuen Agent in Copilot.</p>
        <p>Viel Erfolg beim Erstellen deines Agents.</p>
        <div class="top-note" role="note" aria-label="Datenschutzhinweis">
          <h3>Datenschutzhinweis</h3>
          <p>Der Baukasten speichert keine persönlichen Daten. Alle Eingaben bleiben ausschließlich in deinem Browser und werden nicht an Server übertragen. Beim Schließen der Seite gehen nicht gespeicherte Inhalte verloren.</p>
        </div>
        <button id="startBtn" class="btn">Start</button>
      </div>
    </div>
  </section>
  <!-- END: Startscreen -->

  <!-- START: Builder -->
  <section id="builder">
    <div class="container">
      <h1>Baukasten für Copilot-Chat-Agenten</h1>

      <div class="card">
        <h3>Hinweise zur Bedienung</h3>
        <p class="muted">
          Dieser Baukasten ist in logische Module unterteilt, die ein korrekt aufgebauter Agent benötigt.<br>
          In allen Modulen außer dem ersten kannst du die Texte in den <strong>grünen Feldern</strong> nach Bedarf ändern.<br>
          Bitte achte darauf, dass die <strong>inhaltliche Richtung</strong> und die <strong>maximale Auswahl</strong> erhalten bleibt.<br>
          Unbearbeitete Module fließen nicht in das Agenten Script ein.<br>
          Sobald alle Module ausgefüllt sind, kannst du das fertige Agenten Script mit einem Klick in die Zwischenablage kopieren.
        </p>
      </div>

      <!-- MODUL: Rolle / Persona (unchanged) -->
      <!-- For brevity, not reproducing all unchanged modules from V5.1 here in this generated file. In your environment, you'd keep them intact. -->

      <!-- MODUL-GRUPPE: Grundverhalten V5.2 -->
      <div class="card" id="mod-grundverhalten">
        <h2><strong>Grundverhalten / Arbeitslogik</strong></h2>

        <!-- Startverhalten (Multi, limit 3, size 8) -->
        <div class="subcard" id="sub-startverhalten">
          <h3 style="margin-top:0">Startverhalten</h3>
          <div class="subhint subhint--question">Einstiege: Wähle 1–3 Einstiegstypen.</div>
          <div class="subhint subhint--choose">Max. 3 Optionen — nicht gewählte Optionen sperren, wenn Limit erreicht.</div>
          <select id="startSelect" multiple size="8" aria-describedby="startCount startHint" aria-label="Startverhalten wählen">
            <option>direkter Start</option>
            <option>kurzer Impuls</option>
            <option>kurze Einordnung</option>
            <option>Überblick am Anfang</option>
            <option>freundlicher Einstieg</option>
            <option>sachlich-klarer Einstieg</option>
            <option>ruhiger Einstieg</option>
            <option>kurze Zusammenfassung des Inputs</option>
            <option>neutraler Startsatz</option>
          </select>
          <div class="meta">
            <span id="startCount" aria-live="polite">0 / 3</span>
            <span class="hint" id="startHint" hidden>Maximale Anzahl erreicht.</span>
          </div>
          <div class="preview">
            <p><strong>Einstiegsarten:</strong> <span id="startEditable" class="editable" contenteditable="true"></span></p>
          </div>
          <div class="actions-line">
            <button type="button" class="info-btn" id="infoBtn_start" aria-controls="infoPanel_start" aria-expanded="false" title="Hinweise zu Startverhalten">ℹ️ Hinweise</button>
            <button type="button" class="btn btn--sm" id="startReset">Zurücksetzen (Start)</button>
          </div>
          <div class="info-panel" id="infoPanel_start" role="region" aria-label="Hinweise zum Startverhalten">
            <h4>Hilfetext – Startverhalten</h4>
            <p><strong>Direkt vs. orientierend:</strong> Wähle 1–3 Einstiegstypen (z. B. „direkt“, „kurzer Impuls“, „Überblick“). Sie bestimmen nur den Startton, nicht die Dialoglogik.</p>
            <p><strong>Natürlichkeit:</strong> Die Einstiege werden situativ genutzt und nicht in jeder Antwort identisch wiederholt.</p>
            <p><strong>Abgrenzung:</strong> Rückfragen werden separat unter „Rückfragen‑Logik“ gesteuert, nicht hier.</p>
            <button type="button" class="close-info">Verbergen</button>
          </div>
        </div>

        <!-- Variation / Ausdruck (Multi, limit 3, size 8) -->
        <div class="subcard" id="sub-variation">
          <h3 style="margin-top:0">Variation / Ausdruck</h3>
          <div class="subhint subhint--question">Wie soll die Sprache dezent variieren?</div>
          <div class="subhint subhint--choose">Max. 3 Optionen — nicht gewählte Optionen sperren, wenn Limit erreicht.</div>
          <select id="varSelect" multiple size="8" aria-describedby="variationCount variationHint" aria-label="Variation wählen">
            <option>Einstiegsformulierungen leicht variieren</option>
            <option>Satzbau leicht variieren</option>
            <option>Wortwahl dezent variieren</option>
            <option>Abschlussformulierungen variieren</option>
            <option>Antwortlänge leicht variieren</option>
            <option>natürlichere Tonalität</option>
            <option>dezente Synonyme statt Wiederholungen</option>
            <option>kleine Variation bei Übergängen (z. B. „Weiter…“, „Als Nächstes…“)</option>
          </select>
          <div class="meta">
            <span id="variationCount" aria-live="polite">0 / 3</span>
            <span class="hint" id="variationHint" hidden>Maximale Anzahl erreicht.</span>
          </div>
          <div class="preview">
            <p><strong>Variation:</strong> <span id="varEditable" class="editable" contenteditable="true"></span></p>
          </div>
          <div class="actions-line">
            <button type="button" class="info-btn" id="infoBtn_variation" aria-controls="infoPanel_variation" aria-expanded="false" title="Hinweise zu Variation">ℹ️ Hinweise</button>
            <button type="button" class="btn btn--sm" id="varReset">Zurücksetzen (Variation)</button>
          </div>
          <div class="info-panel" id="infoPanel_variation" role="region" aria-label="Hinweise zu Variation / Ausdruck">
            <h4>Hilfetext – Variation</h4>
            <p><strong>Ziel:</strong> Leichte sprachliche Abwechslung für ein natürliches Lesegefühl.</p>
            <p><strong>Rahmen:</strong> Variation betrifft Wortwahl, Satzbau, Einstieg/Abschluss – Struktur und Inhalt bleiben gleich.</p>
            <p><strong>Grenze:</strong> Klarheit geht vor Abwechslung; keine künstliche Verlängerung.</p>
            <button type="button" class="close-info">Verbergen</button>
          </div>
        </div>

        <!-- Antwortstil / Spezifität (Single, size 8) -->
        <div class="subcard" id="sub-antwortstil">
          <h3 style="margin-top:0">Antwortstil / Spezifität</h3>
          <div class="subhint subhint--question">Wie sollen Antworten strukturiert sein?</div>
          <div class="subhint subhint--choose">Wähle genau eine Option:</div>
          <select id="tiefeSelect" size="8" aria-label="Antwortstil wählen">
            <option>kompakt & direkt</option>
            <option>schrittweise/strukturiert</option>
            <option>technisch präzise</option>
            <option>praxisnah mit Beispielen</option>
            <option>ausführlich erklärend</option>
            <option>tabellarische Darstellung</option>
            <option>Pro/Contra‑Struktur</option>
            <option>klare Handlungsempfehlungen</option>
          </select>
          <div class="preview">
            <p><strong>Antwortstil:</strong> <span id="tiefeEditable" class="editable" contenteditable="true"></span></p>
          </div>
          <div class="actions-line">
            <button type="button" class="info-btn" id="infoBtn_tiefe" aria-controls="infoPanel_tiefe" aria-expanded="false" title="Hinweise zu Antwortstil">ℹ️ Hinweise</button>
            <button type="button" class="btn btn--sm" id="tiefeReset">Zurücksetzen (Antwortstil)</button>
          </div>
          <div class="info-panel" id="infoPanel_tiefe" role="region" aria-label="Hinweise zum Antwortstil">
            <h4>Hilfetext – Antwortstil</h4>
            <p><strong>Aufgabe:</strong> Legt den inhaltlichen Aufbau fest.</p>
            <p><strong>Konsistenz:</strong> Eine Option wählen und durchhalten.</p>
            <p><strong>Tipp:</strong> „Schrittweise/strukturiert“ ist oft ein guter Default.</p>
            <button type="button" class="close-info">Verbergen</button>
          </div>
        </div>

        <!-- Rückfragen-Logik (Single, size 8) -->
        <div class="subcard" id="sub-rueckfragen">
          <h3 style="margin-top:0">Rückfragen‑Logik</h3>
          <div class="subhint subhint--question">Welche Rückfragenregel soll gelten?</div>
          <div class="subhint subhint--choose">Wähle genau eine Option:</div>
          <select id="rqSelect" size="8" aria-label="Rückfragen-Logik wählen">
            <option>keine Rückfragen</option>
            <option>Rückfragen nur bei Unklarheit (max. 1)</option>
            <option>Zielbild klären (1 Frage)</option>
            <option>Kontext klären (1 Frage)</option>
            <option>Rückfrage am Ende</option>
            <option>Scope‑Frage bei Mehrdeutigkeit</option>
            <option>optionale Bestätigungsfrage („Soll ich weiter ins Detail gehen?“)</option>
          </select>
          <div class="preview">
            <p><strong>Rückfragen‑Logik:</strong> <span id="rqEditable" class="editable" contenteditable="true"></span></p>
          </div>
          <div class="actions-line">
            <button type="button" class="info-btn" id="infoBtn_rq" aria-controls="infoPanel_rq" aria-expanded="false" title="Hinweise zur Rückfragen‑Logik">ℹ️ Hinweise</button>
            <button type="button" class="btn btn--sm" id="rqReset">Zurücksetzen (Rückfragen)</button>
          </div>
          <div class="info-panel" id="infoPanel_rq" role="region" aria-label="Hinweise zur Rückfragen-Logik">
            <h4>Hilfetext – Rückfragen‑Logik</h4>
            <p><strong>Nutzen:</strong> Rückfragen erhöhen Treffgenauigkeit, ohne den Fluss zu stören.</p>
            <p><strong>Begrenzung:</strong> Max. eine Regel – eindeutiges Verhalten.</p>
            <p><strong>Praxis:</strong> „Nur bei Unklarheit (max. 1)“ ist universell.</p>
            <button type="button" class="close-info">Verbergen</button>
          </div>
        </div>

        <!-- Recherche & Quellen (Single, size 8) -->
        <div class="subcard" id="sub-recherche">
          <h3 style="margin-top:0">Recherche & Quellen</h3>
          <div class="subhint subhint--question">Wie soll recherchiert und zitiert werden?</div>
          <div class="subhint subhint--choose">Wähle genau eine Option:</div>
          <select id="recSelect" size="8" aria-label="Rechercheverhalten wählen">
            <option>keine Websuche</option>
            <option>Websuche bei Bedarf</option>
            <option>Websuche mit Quellenangabe (Titel/Datum/Link)</option>
            <option>Websuche nur bei externen Themen</option>
            <option>externe Infos als Stichpunkte</option>
            <option>vor Recherche einmal Rückfrage bei Unklarheit</option>
            <option>Recherche präzise, keine Vermutungen</option>
          </select>
          <div class="preview">
            <p><strong>Recherche:</strong> <span id="recEditable" class="editable" contenteditable="true"></span></p>
          </div>
          <div class="actions-line">
            <button type="button" class="info-btn" id="infoBtn_recherche" aria-controls="infoPanel_recherche" aria-expanded="false" title="Hinweise zu Recherche">ℹ️ Hinweise</button>
            <button type="button" class="btn btn--sm" id="recReset">Zurücksetzen (Recherche)</button>
          </div>
          <div class="info-panel" id="infoPanel_recherche" role="region" aria-label="Hinweise zur Recherche">
            <h4>Hilfetext – Recherche & Quellen</h4>
            <p><strong>Transparenz:</strong> Quellen bei externen Themen nennen.</p>
            <p><strong>Reihenfolge:</strong> Erst klären, dann suchen.</p>
            <p><strong>Sicherheit:</strong> Keine Vermutungen als Fakten.</p>
            <button type="button" class="close-info">Verbergen</button>
          </div>
        </div>

      </div>

      <!-- COPY area -->
      <div class="card copy-area" id="copyArea">
        <div class="title-line">Das Agent-Script kann nun gespeichert werden</div>
        <button class="btn" id="copyBtn">Kopieren in Zwischenablage</button>
        <div class="copy-msg" id="copyMsg">Agent‑Skript wurde in die Zwischenablage kopiert!</div>
      </div>

      <!-- Anleitung (unchanged content can be kept from V5.1) -->
    </div>
  </section>
  <!-- END: Builder -->

  <script>
    // --- State ---
    const state = {
      // Unveränderte Module würden hier stehen (rolle, purpose, tasks, stil)
      start: { selected: [], limit: 3, edited:false },
      variation: { selected: [], limit: 3, edited:false },
      tiefe: { selected: '', edited:false },
      rq: { selected: '', edited:false },
      recherche: { selected: '', edited:false }
    };

    // --- Helpers ---
    const qs = (sel, root=document) => root.querySelector(sel);
    const joinList = (arr) => arr.join(', ');
    const textOrEmpty = (selector) => (qs(selector)?.textContent || '').trim();

    // Toggle-Multi without CTRL
    function enableClickToggle(selectEl, key){
      selectEl.addEventListener('mousedown', (e) => {
        const opt = e.target;
        if(opt && opt.tagName === 'OPTION'){
          e.preventDefault();
          opt.selected = !opt.selected;
          selectEl.dispatchEvent(new Event('change', {bubbles:true}));
          selectEl.focus();
        }
      });
    }

    function enforceMultiLimit(selectEl, key){
      const { limit } = state[key];
      const current = Array.from(selectEl.options).filter(o=>o.selected).map(o=>o.text);
      const prev = state[key].selected.slice();
      const kept = prev.filter(x=>current.includes(x));
      const added = current.filter(x=>!prev.includes(x));
      const merged = kept.concat(added);
      if(merged.length > limit){
        const toDeselect = merged.slice(limit);
        Array.from(selectEl.options).forEach(o=>{ if(toDeselect.includes(o.text)) o.selected=false; });
        state[key].selected = merged.slice(0,limit);
      } else {
        state[key].selected = merged;
      }
      // UI counter + hint + disable remaining
      const countEl = qs(`#${key==='variation'?'variation':'start'}Count`);
      const hintEl = qs(`#${key==='variation'?'variation':'start'}Hint`);
      if(countEl) countEl.textContent = `${state[key].selected.length} / ${limit}`;
      const atMax = state[key].selected.length >= limit;
      if(hintEl) hintEl.hidden = !atMax;
      Array.from(selectEl.options).forEach(o=>{ if(!o.selected) o.disabled = atMax; });
      // preview update if not manually edited
      updateEditableFromSelection(key);
    }

    function updateEditableFromSelection(key){
      if(state[key].edited) return;
      const map = {
        start: { span: '#startEditable', value: joinList(state.start.selected) },
        variation: { span: '#varEditable', value: joinList(state.variation.selected) },
        tiefe: { span: '#tiefeEditable', value: state.tiefe.selected },
        rq: { span: '#rqEditable', value: state.rq.selected },
        recherche: { span: '#recEditable', value: state.recherche.selected }
      };
      const target = map[key];
      if(target){ qs(target.span).textContent = target.value; }
    }

    function updateSingleSelect(selectEl, key){
      const val = selectEl.value || '';
      state[key].selected = val;
      if(state[key].edited) return;
      const spanId = ({ tiefe:'#tiefeEditable', rq:'#rqEditable', recherche:'#recEditable' })[key];
      if(spanId){ qs(spanId).textContent = val; }
    }

    function resetModule(key){
      switch(key){
        case 'start':{
          const el = qs('#startSelect');
          Array.from(el.options).forEach(o=>{o.selected=false;o.disabled=false;});
          state.start.selected = [];
          state.start.edited = false;
          qs('#startEditable').textContent = '';
          qs('#startCount').textContent = `0 / ${state.start.limit}`;
          qs('#startHint').hidden = true;
          break;}
        case 'variation':{
          const el = qs('#varSelect');
          Array.from(el.options).forEach(o=>{o.selected=false;o.disabled=false;});
          state.variation.selected = [];
          state.variation.edited = false;
          qs('#varEditable').textContent = '';
          qs('#variationCount').textContent = `0 / ${state.variation.limit}`;
          qs('#variationHint').hidden = true;
          break;}
        case 'tiefe':{
          qs('#tiefeSelect').selectedIndex = -1;
          state.tiefe.selected = '';
          state.tiefe.edited = false;
          qs('#tiefeEditable').textContent = '';
          break;}
        case 'rq':{
          qs('#rqSelect').selectedIndex = -1;
          state.rq.selected = '';
          state.rq.edited = false;
          qs('#rqEditable').textContent = '';
          break;}
        case 'recherche':{
          qs('#recSelect').selectedIndex = -1;
          state.recherche.selected = '';
          state.recherche.edited = false;
          qs('#recEditable').textContent = '';
          break;}
      }
    }

    function getModuleTextFromEditableOrSelection(spanSelector, selected){
      const t = textOrEmpty(spanSelector);
      if(t) return t;
      if(Array.isArray(selected)) return selected.length ? joinList(selected) : '';
      return selected || '';
    }

    function buildScript(){
      const parts = [];
      // Grundverhalten / Arbeitslogik Sätze in neuer Reihenfolge
      const start = getModuleTextFromEditableOrSelection('#startEditable', state.start.selected);
      const variation = getModuleTextFromEditableOrSelection('#varEditable', state.variation.selected);
      const antwortstil = getModuleTextFromEditableOrSelection('#tiefeEditable', state.tiefe.selected);
      const rueckfragen = getModuleTextFromEditableOrSelection('#rqEditable', state.rq.selected);
      const recherche = getModuleTextFromEditableOrSelection('#recEditable', state.recherche.selected);

      const g = [];
      if(start) g.push(`Für den Einstieg nutzt du <STARTVERHALTEN>, situativ und ohne wiederholende Muster.`.replace('<STARTVERHALTEN>', start));
      if(variation) g.push(`Du variierst deinen Ausdruck dezent durch <VARIATION>, damit Antworten natürlich und nicht repetitiv wirken.`.replace('<VARIATION>', variation));
      if(antwortstil) g.push(`Deine Antworten folgen dem Stil <ANTWORTSTIL>, damit Inhalte klar, nachvollziehbar und strukturiert bleiben.`.replace('<ANTWORTSTIL>', antwortstil));
      if(rueckfragen) g.push(`Deine Rückfragenlogik lautet: <RUECKFRAGEN>.`.replace('<RUECKFRAGEN>', rueckfragen));
      if(recherche) g.push(`Dein Recherche‑ und Quellenverhalten ist: <RECHERCHE>.`.replace('<RECHERCHE>', recherche));

      if(g.length){
        parts.push(`[Grundverhalten / Arbeitslogik]\nDu arbeitest nach folgender festen Logik:\n\n` + g.join("\n\n"));
      }

      return parts.join('\n\n').trim();
    }

    function wireInfoPanel(key){
      const btn = qs(`#infoBtn_${key}`);
      const panel = qs(`#infoPanel_${key}`);
      if(!btn || !panel) return;
      const closeBtn = panel.querySelector('.close-info');
      function open(){ panel.style.display='block'; btn.setAttribute('aria-expanded','true'); closeBtn && closeBtn.focus(); }
      function close(){ panel.style.display='none'; btn.setAttribute('aria-expanded','false'); btn.focus(); }
      btn.addEventListener('click', ()=>{ const isOpen = panel.style.display==='block'; isOpen?close():open(); });
      closeBtn && closeBtn.addEventListener('click', close);
      panel.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
    }

    async function copyToClipboard(text){
      try{
        if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(text); }
        else { const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.focus(); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
        return true;
      }catch(e){ console.error(e); return false; }
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      // Start -> Builder
      const startBtn = qs('#startBtn');
      startBtn.addEventListener('click', ()=>{
        qs('#start').style.display='none';
        qs('#builder').style.display='block';
        qs('#startSelect').focus();
      });

      // Info panels
      ['start','variation','tiefe','rq','recherche'].forEach(wireInfoPanel);

      // Multi selects (start, variation)
      [{sel:'#startSelect', key:'start'},{sel:'#varSelect', key:'variation'}].forEach(d=>{
        const el = qs(d.sel);
        enableClickToggle(el, d.key);
        el.addEventListener('change', e=>enforceMultiLimit(e.target, d.key));
      });

      // Single selects
      qs('#tiefeSelect').addEventListener('change', e=>updateSingleSelect(e.target, 'tiefe'));
      qs('#rqSelect').addEventListener('change', e=>updateSingleSelect(e.target, 'rq'));
      qs('#recSelect').addEventListener('change', e=>updateSingleSelect(e.target, 'recherche'));

      // Editable flags
      qs('#startEditable').addEventListener('input', ()=> state.start.edited = true);
      qs('#varEditable').addEventListener('input', ()=> state.variation.edited = true);
      qs('#tiefeEditable').addEventListener('input', ()=> state.tiefe.edited = true);
      qs('#rqEditable').addEventListener('input', ()=> state.rq.edited = true);
      qs('#recEditable').addEventListener('input', ()=> state.recherche.edited = true);

      // Copy
      qs('#copyBtn').addEventListener('click', async ()=>{
        const script = buildScript();
        const ok = await copyToClipboard(script);
        const msg = qs('#copyMsg');
        msg.style.display = ok ? 'block' : 'none';
        if(!ok) alert('Kopieren nicht möglich. Bitte manuell kopieren.');
        if(ok) setTimeout(()=> msg.style.display='none', 4000);
      });
    });
  </script>
</body>
</html>
